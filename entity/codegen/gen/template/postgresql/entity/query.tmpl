{{ define "entity/query" }}
{{ $entity := toFirstLower $.Entity.Name}}
{{ $entityAttr := $.Entity.AttrName }}
{{ $header := dict "Package" "entity" }}
{{ template "header" $header }}

{{ $importPkgs := dict "ImportPkgs" $.Entity.ImportPkgs "Package" $.Config.Package  "Entity" $.Entity }}
{{ template "import/load" $importPkgs }}

// {{ $entity }}Query is the query action for the {{ $entity }}.
type {{ $entity }}Query struct {
	config     *{{ toFirstLower $entity}}Config
	ctx        *entitysql.QueryContext
	predicates []entitysql.PredicateFunc
	rels 	 []{{ $entity }}Rel
	order	  []{{ $.Entity.AttrName }}.OrderTerm
	scanner	[]*internal.QueryScanner
	scannerTotal int
}

// First returns the first result of the query.
func (o *{{ $entity }}Query) First(ctx context.Context) (*{{toFirstCap $entity }}, error) {
	result, err := o.Single(ctx)
	if err != nil {
		return nil, err
	}
	return result, nil
}

// new{{ toFirstCap $entity }}Query creates a new {{ $entity }}Query.
func new{{ toFirstCap $entity }}Query(c *internal.Dialect,t entity.Tracker, ms *{{ toFirstLower $entity  }}Mutations) *{{ $entity }}Query {
	return &{{ $entity }}Query{
		config: &{{ toFirstLower $entity }}Config{
			Dialect:    c,
			{{ toFirstLower $entity }}Mutations: ms,
		},
		ctx:    &entitysql.QueryContext{},
		predicates: []entitysql.PredicateFunc{},
		rels: []{{ $entity }}Rel{},
		order: []{{ $.Entity.AttrName }}.OrderTerm{},
		scanner: []*internal.QueryScanner{},
		scannerTotal: 0,
	}
}

func (o *{{ $entity }}Query) Where(predicates ...entitysql.PredicateFunc) *{{ $entity }}Query {
	o.predicates = append(o.predicates, predicates...)
	return o
}

// Limit sets the limit of the query.
func (o *{{ $entity }}Query) Limit(limit int) *{{ $entity }}Query {
	o.ctx.Limit = &limit
	return o
}

func (o *{{ $entity }}Query) Order(term ...{{ $entityAttr }}.OrderTerm) *{{ $entity }}Query {
	o.order = append(o.order, term...)
	return o
}

func (o *{{ $entity }}Query) Include(rels ...{{ $entity }}Rel) *{{  $entity }}Query {
	o.rels = append(o.rels, rels...)
	return o
}

// ToList returns the list of results of the query.
func (o *{{ $entity }}Query) ToList(ctx context.Context) ([]*{{ toFirstCap $entity }}, error) {
	return o.sqlAll(ctx)
}

// Single returns the single result of the query.
func (o *{{ $entity }}Query) Single(ctx context.Context) (*{{ toFirstCap $entity }}, error) {
	limit := 1
	o.ctx.Limit = &limit
	return o.sqlSingle(ctx)
}

func (o *{{ $entity }}Query) sqlSingle(ctx context.Context) (*{{ toFirstCap $entity }}, error) {
	var (
		spec   = o.querySpec()
		res  = o.config.New()
	)
	switch res := res.(type) {
	case *{{ toFirstCap $entity }}:
		spec.Scan = func(rows dialect.Rows, fields []entitysql.ScannerField) error {
			builder := entitysql.NewScannerBuilder(o.scannerTotal)
			builder.Append(0,res.scan(fields)...)
			for _, s := range o.scanner {
				res.createRel(builder, s)
			}

			return rows.Scan(builder.Flatten()...)
		}
		if err := entitysql.NewQuery(ctx, o.config.Driver, spec); err != nil {
			return nil, err
		}
		if err := res.setUnchanged(); err != nil {
			return nil, err
		}
		for _, r := range o.rels {
			r.reset()
		}
		return res, nil
	default:
		return nil, entity.Err_0100030006
	}
}

func (o *{{ $entity }}Query) sqlAll(ctx context.Context) ([]*{{ toFirstCap $entity }}, error) {
	var (
		spec = o.querySpec()
		res  = []*{{ toFirstCap $entity }}{}
	)
	spec.Scan = func(rows dialect.Rows, fields []entitysql.ScannerField) error {
		e := o.config.New()
		switch e := e.(type) {
		case *{{ toFirstCap $entity }}:
			builder := entitysql.NewScannerBuilder(o.scannerTotal + 1)
			builder.Append(0,e.scan([]entitysql.ScannerField{})...)
			for _, s := range o.scanner {
				e.createRel(builder, s)
			}

			if err := rows.Scan(builder.Flatten()...); err != nil {
				return err
			} else {
				res = merge{{ toFirstCap $entity }}(res, e)
				return nil
			}
		default:
			return entity.Err_0100030006
		}
	}
	if err := entitysql.NewQuery(ctx, o.config.Driver, spec); err != nil {
		return nil, err
	}
	for _, e := range res {
		if err := e.setUnchanged(); err != nil {
			return nil, err
		}
	}
	for _, r := range o.rels {
		rel := r
		rel.reset()
	}
	return res, nil
}

func (o *{{ $entity }}Query) querySpec() *entitysql.QuerySpec {
	s := entitysql.NewQuerySpec({{ $entityAttr }}.Entity, {{ $entityAttr }}.Columns)
	if o.ctx.Limit != nil {
		s.Limit = *o.ctx.Limit
	}
	if fields := o.ctx.Fields; len(fields) > 0 {
		s.Entity.Columns = make([]entitysql.FieldName, 0, len(fields))
		s.Entity.Columns = append(s.Entity.Columns, fields...)
	}
	if ps := o.predicates; len(ps) > 0 {
		s.Predicate = func(p *entitysql.Predicate, as string) {
			for _, f := range ps {
				f(p,as)
			}
		}
	}
	if rs := o.rels; len(rs) > 0 {
		s.Rels = make([]entitysql.Relation, 0, len(rs))
		s.Orders = append(s.Orders, {{ $entityAttr }}.ByPrimary)
		for _, r := range rs {
			rel := r
			s.Rels = append(s.Rels, func (s *entitysql.Selector)  {
				o.scanner =  o.addRels(s, s.Table(), rel, o.scanner)
			})
		}
	}
	for _, o := range o.order {
		s.Orders = append(s.Orders, func (order *entitysql.Order)  {
			o.Apply(order)
		})
	}
	return s
}

func (o *{{ $entity }}Query) addRels(s *entitysql.Selector,t *entitysql.SelectTable, rel rel, scanner []*internal.QueryScanner)  []*internal.QueryScanner {
	desc, children, config := rel.Desc()
	join := entitysql.AddRelBySelector(s, t, desc)
	_, tableNum := join.GetAs()
	qs := internal.QueryScanner{Config: config,Children: []*internal.QueryScanner{}, TableNum: tableNum}
	scanner = append(scanner, &qs)
	o.scannerTotal++
	if len(children) > 0 {
		for _, c := range children {
			qs.Children = o.addRels(s, join, c, qs.Children)
		}
	}
	return scanner
}

{{ end }}